<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>L8teSearch - Zentrale Research Hub</title>
    <!-- Abhängigkeiten -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <!-- Nur Google Material Symbols & Inter Font -->
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&amp;display=swap"
        rel="stylesheet" />
    <style type="text/tailwindcss">
        @layer base {
            body {
                @apply font-['Inter',-apple-system,BlinkMacSystemFont,sans-serif] antialiased;
                background: 
                    radial-gradient(at 0% 0%, rgba(130, 180, 255, 0.15) 0px, transparent 50%),
                    radial-gradient(at 100% 0%, rgba(180, 150, 255, 0.15) 0px, transparent 50%),
                    radial-gradient(at 100% 100%, rgba(100, 220, 255, 0.1) 0px, transparent 50%),
                    radial-gradient(at 0% 100%, rgba(255, 150, 200, 0.1) 0px, transparent 50%),
                    #f8fafc;
            }
        }
        .glass-panel {
            @apply bg-white/40 backdrop-blur-2xl border border-white/40 shadow-[0_8px_32px_0_rgba(31,38,135,0.07)];
        }
        .glass-item {
            @apply bg-white/30 backdrop-blur-md border border-white/40 shadow-sm transition-all duration-300;
        }
        .glass-input {
            @apply bg-white/40 backdrop-blur-lg border border-slate-200 focus:bg-white/60 focus:border-blue-400 focus:ring-0 transition-all shadow-sm;
        }
        /* Sidebar Search Input - High Contrast */
        .sidebar-search-input {
            @apply bg-slate-200/20 backdrop-blur-lg border border-slate-300/50 focus:bg-white/80 focus:border-blue-500 focus:ring-0 transition-all text-slate-900 placeholder-slate-500;
        }
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
            display: inline-block;
            vertical-align: middle;
            line-height: 1;
        }
        .nav-tab.active {
            @apply text-blue-600 bg-blue-600/5;
        }
        .view { display: none; }
        .view.active { display: block; }
        .view.active.flex { display: flex; }
        
        .view-animate-in {
            animation: view-slide-up 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }
        @keyframes view-slide-up {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.1); border-radius: 10px; }

        .dropdown-animate {
            @apply transition-all duration-200 ease-out origin-top transform scale-95 opacity-0 pointer-events-none;
        }
        .dropdown-animate.show {
            @apply scale-100 opacity-100 pointer-events-auto;
        }

        #reader-sidebar {
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.2s ease;
        }
        #reader-sidebar.collapsed {
            @apply w-0 opacity-0 border-none overflow-hidden p-0;
        }
        .resizer-handle {
            @apply absolute top-0 right-0 w-1.5 h-full cursor-col-resize z-50 transition-colors hover:bg-blue-500/30;
        }
        .resizer-handle.is-resizing {
            @apply bg-blue-500/50 w-2;
        }

        .reader-content-text h1 { @apply text-4xl font-bold mb-6 text-slate-900; }
        .reader-content-text p { @apply text-lg leading-relaxed mb-4 text-slate-700; }

        /* Mindmap Branch lines */
        .mindmap-branch {
            @apply relative pl-8 border-l border-slate-300 ml-4;
        }
        .mindmap-node::before {
            content: '';
            @apply absolute -left-8 top-1/2 w-8 h-[1px] bg-slate-300;
        }
    </style>
</head>

<body class="min-h-screen text-slate-800 pb-12">

    <!-- HEADER: Projektsteuerung & Navigation -->
    <header class="sticky top-4 z-50 mx-auto max-w-7xl px-4 pointer-events-none">
        <div class="glass-panel rounded-[2rem] px-8 py-4 flex items-center justify-between pointer-events-auto">
            <div class="flex items-center gap-8">
                <div class="flex items-center gap-2 cursor-pointer" onclick="switchTab('dashboard')">
                    <div
                        class="w-10 h-10 rounded-2xl bg-gradient-to-tr from-blue-500 to-indigo-500 flex items-center justify-center shadow-lg shadow-blue-500/20 text-white">
                        <span class="material-symbols-outlined text-2xl font-bold">hub</span>
                    </div>
                    <span class="text-xl font-semibold tracking-tight text-slate-900">L8teSearch</span>
                </div>
                <div class="h-8 w-px bg-slate-200/50"></div>
                <nav class="flex items-center gap-1">
                    <button onclick="switchTab('dashboard')" id="tab-dashboard"
                        class="nav-tab active px-4 py-2 rounded-xl text-sm font-medium transition-all">Übersicht</button>
                    <button onclick="switchTab('library')" id="tab-library"
                        class="nav-tab px-4 py-2 rounded-xl text-sm font-medium transition-all">Bibliothek</button>
                    <button onclick="switchTab('notes')" id="tab-notes"
                        class="nav-tab px-4 py-2 rounded-xl text-sm font-medium transition-all">Notizen</button>
                    <button onclick="switchTab('mindmap')" id="tab-mindmap"
                        class="nav-tab px-4 py-2 rounded-xl text-sm font-medium transition-all">Mindmap</button>
                </nav>
            </div>

            <div class="flex items-center gap-3">
                <div class="relative group mr-2">
                    <button onclick="toggleProjectDropdown()" id="project-dropdown-btn"
                        class="flex items-center gap-3 bg-white/40 hover:bg-white/60 border-0 text-sm font-bold rounded-2xl px-4 py-2.5 transition-all min-w-[200px]">
                        <span id="selected-project-name">Projekt wählen...</span>
                        <span class="material-symbols-outlined text-slate-400 text-xl ml-auto">expand_more</span>
                    </button>
                    <div id="project-dropdown-menu"
                        class="dropdown-animate absolute top-full left-0 right-0 mt-2 glass-panel rounded-2xl p-2 z-[60]">
                        <div class="space-y-1" id="project-dropdown-items">
                            <!-- Injected Projects -->
                        </div>
                        <div class="border-t border-slate-100 my-1 pt-1">
                            <button onclick="createNewProject()"
                                class="w-full text-left px-4 py-2 text-sm font-bold text-blue-600 hover:bg-blue-600/5 rounded-xl transition-all flex items-center gap-2">
                                <span class="material-symbols-outlined text-lg">add</span> Neues Projekt
                            </button>
                        </div>
                    </div>
                </div>

                <button onclick="openAddUrlModal()"
                    class="p-2.5 bg-blue-600 text-white rounded-2xl shadow-lg shadow-blue-500/20 hover:scale-105 active:scale-95 transition-all flex items-center justify-center">
                    <span class="material-symbols-outlined">add</span>
                </button>
                <button onclick="exportProject()"
                    class="p-2.5 hover:bg-slate-900/5 text-slate-500 rounded-2xl transition-all flex items-center justify-center">
                    <span class="material-symbols-outlined">ios_share</span>
                </button>
                <button onclick="deleteCurrentProject()"
                    class="p-2.5 hover:bg-red-500/10 text-red-500/70 rounded-2xl transition-all flex items-center justify-center">
                    <span class="material-symbols-outlined">delete</span>
                </button>
            </div>
        </div>
    </header>

    <main id="main-app" class="max-w-7xl mx-auto px-4 py-8 space-y-8" style="display:none;">
        <!-- 1. DASHBOARD VIEW -->
        <div id="view-dashboard" class="view active space-y-8">
            <section class="glass-panel rounded-[2.5rem] p-8">
                <div class="flex items-center justify-between mb-8">
                    <div class="flex items-center gap-3">
                        <div class="w-2 h-8 bg-blue-500 rounded-full"></div>
                        <div>
                            <h2 class="text-lg font-bold text-slate-900">Letzte Quellen</h2>
                            <p class="text-xs text-slate-500 font-medium">Aktuelle Recherche-Materialien</p>
                        </div>
                    </div>
                    <button onclick="switchTab('library')"
                        class="text-sm font-semibold text-blue-600 hover:text-blue-700">Alle anzeigen</button>
                </div>
                <div id="recent-grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-6"></div>
            </section>
            <section class="glass-panel rounded-[2.5rem] p-8">
                <div class="flex items-center justify-between mb-8">
                    <div class="flex items-center gap-3">
                        <div class="w-2 h-8 bg-purple-500 rounded-full"></div>
                        <div>
                            <h2 class="text-lg font-bold text-slate-900">Wichtige Erkenntnisse</h2>
                            <p class="text-xs text-slate-500 font-medium">Zuletzt gespeicherte Notizen</p>
                        </div>
                    </div>
                    <button onclick="switchTab('notes')"
                        class="text-sm font-semibold text-blue-600 hover:text-blue-700">Zu allen Notizen</button>
                </div>
                <div id="recent-notes" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </section>
        </div>

        <!-- 2. LIBRARY VIEW -->
        <div id="view-library" class="view space-y-8">
            <section class="glass-panel rounded-[2.5rem] p-8 min-h-[60vh]">
                <div class="flex items-center justify-between mb-8">
                    <div class="flex items-center gap-3">
                        <div class="w-2 h-8 bg-blue-500 rounded-full"></div>
                        <h2 class="text-2xl font-bold text-slate-900">Vollständige Bibliothek</h2>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="relative mr-2">
                            <span
                                class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-lg">search</span>
                            <input class="glass-input w-[250px] rounded-2xl pl-10 pr-4 py-2 text-sm"
                                placeholder="Suchen..." type="text" />
                        </div>
                        <button onclick="openAddUrlModal()"
                            class="flex items-center gap-2 px-5 py-2.5 bg-slate-900 text-white text-sm font-bold rounded-2xl transition-all shadow-lg shadow-slate-900/10">
                            <span class="material-symbols-outlined text-[20px]">add</span>
                            <span>Neu</span>
                        </button>
                    </div>
                </div>
                <div id="full-library-grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-6"></div>
            </section>
        </div>

        <!-- 3. NOTES VIEW -->
        <div id="view-notes" class="view space-y-8">
            <section class="glass-panel rounded-[2.5rem] p-8">
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-6 mb-10">
                    <div class="flex items-center gap-3">
                        <div class="w-2 h-8 bg-purple-500 rounded-full"></div>
                        <h2 class="text-2xl font-bold text-slate-900">Notizen & Insights</h2>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="relative">
                            <span
                                class="material-symbols-outlined absolute left-3.5 top-1/2 -translate-y-1/2 text-slate-400 text-lg">search</span>
                            <input id="note-search-input" onkeyup="filterNotes()"
                                class="glass-input w-[300px] rounded-2xl pl-11 pr-4 py-2.5 text-sm"
                                placeholder="Notizen durchsuchen..." type="text" />
                        </div>
                        <button onclick="autoGroupNotes()"
                            class="flex items-center gap-2 px-5 py-2.5 bg-blue-600/10 text-blue-600 hover:bg-blue-600/20 text-sm font-semibold rounded-2xl transition-all flex items-center justify-center">
                            <span class="material-symbols-outlined text-[20px] mr-2">magic_button</span>
                            <span>Auto-group</span>
                        </button>
                    </div>
                </div>
                <div id="notes-list" class="space-y-10"></div>
            </section>
        </div>

        <!-- 4. MINDMAP VIEW -->
        <div id="view-mindmap" class="view space-y-8">
            <section class="glass-panel rounded-[2.5rem] p-8 min-h-[70vh] flex flex-col">
                <div class="flex items-center justify-between mb-8">
                    <div class="flex items-center gap-3">
                        <div class="w-2 h-8 bg-emerald-500 rounded-full"></div>
                        <div>
                            <h2 class="text-2xl font-bold text-slate-900">Projekt Mindmap</h2>
                            <p class="text-xs text-slate-500 font-medium">Strukturiere deine Gedanken und plane dein
                                Projekt</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <button onclick="addMindmapNode(null)"
                            class="flex items-center gap-2 px-5 py-2.5 bg-slate-900 text-white text-sm font-bold rounded-2xl transition-all shadow-lg shadow-slate-900/10">
                            <span class="material-symbols-outlined text-[20px]">add_circle</span>
                            <span>Neuer Hauptpunkt</span>
                        </button>
                    </div>
                </div>

                <!-- Canvas Area for Graph -->
                <div id="mynetwork" class="w-full h-[600px] border border-slate-100 rounded-[2rem] bg-white/30"></div>

                <!-- Tree Fallback Area (Old Mindmap style) -->
                <div id="mindmap-tree-container" class="mt-8 p-6 overflow-x-auto hidden">
                    <!-- Tree rendered here -->
                </div>
            </section>
        </div>
    </main>

    <!-- Project List Empty State -->
    <div id="no-project-msg" class="max-w-xl mx-auto mt-32 text-center p-12 glass-panel rounded-[3rem]">
        <h2 class="text-2xl font-bold text-slate-900 mb-4">Willkommen bei L8teSearch</h2>
        <p class="text-slate-500 mb-8 font-medium">Wähle ein Projekt aus oder erstelle ein neues, um mit deiner
            Recherche zu beginnen.</p>
        <button onclick="createNewProject()"
            class="bg-slate-900 text-white px-10 py-4 rounded-2xl font-bold text-sm shadow-xl hover:scale-105 transition-all">Neues
            Projekt erstellen</button>
    </div>

    <!-- READER VIEW -->
    <div id="view-reader" class="fixed inset-0 bg-white z-[100] hidden flex-col">
        <header class="h-16 glass-panel border-b border-white/40 px-6 flex items-center justify-between shrink-0 z-50">
            <div class="flex items-center gap-4">
                <button onclick="toggleSidebar()"
                    class="p-2 hover:bg-slate-100/50 rounded-xl text-slate-600 transition-all flex items-center justify-center">
                    <span id="sidebar-toggle-icon" class="material-symbols-outlined">menu_open</span>
                </button>
                <button onclick="closeReader()"
                    class="p-2.5 hover:bg-slate-900/5 text-blue-600 rounded-2xl transition-all flex items-center gap-2 font-bold text-sm">
                    <span class="material-symbols-outlined">arrow_back</span>
                    Zentrale
                </button>
                <div class="h-8 w-px bg-slate-200"></div>
                <span id="reader-title" class="font-bold text-slate-900 truncate max-w-md">Dokument Reader</span>
            </div>
            <div class="flex items-center gap-3">
                <!-- New Inline Save Button (Hidden by default) -->
                <button id="header-save-btn" onclick="saveSelectedTextFromHeader()"
                    class="hidden items-center gap-2 px-6 py-2 bg-indigo-600 text-white rounded-xl text-xs font-bold shadow-lg shadow-indigo-500/30 hover:bg-indigo-700 transition-all hover:scale-105 active:scale-95">
                    <span class="material-symbols-outlined text-sm">edit_note</span>
                    AUSWAHL SPEICHERN
                </button>

                <div class="bg-slate-100 p-1 rounded-2xl flex border border-slate-200 shadow-inner">
                    <button onclick="setReaderMode('original')" id="btn-orig"
                        class="px-5 py-1.5 text-xs font-bold rounded-xl transition-all bg-white shadow-sm text-blue-600">Original</button>
                    <button onclick="setReaderMode('reader')" id="btn-reader"
                        class="px-5 py-1.5 text-xs font-bold rounded-xl transition-all text-slate-400">Reader
                        Mode</button>
                </div>
                <div class="relative">
                    <input id="sidebar-search" onkeypress="if(event.key === 'Enter') startSidebarSearch()"
                        class="sidebar-search-input rounded-xl pl-4 pr-10 py-1.5 text-xs font-medium w-48"
                        placeholder="Google Suche..." type="text" />
                    <span
                        class="material-symbols-outlined absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 text-sm">search</span>
                </div>
            </div>
        </header>
        <div class="flex-1 flex overflow-hidden">
            <!-- New Glass Sidebar -->
            <aside id="reader-sidebar"
                class="w-[300px] border-r border-slate-200/50 flex flex-col shrink-0 bg-slate-50/50 backdrop-blur-3xl transition-all duration-300">
                <div class="p-6 space-y-8 overflow-y-auto flex-1">
                    <div>
                        <p class="text-[10px] font-black text-blue-500 uppercase tracking-[0.2em] mb-4">Projekt</p>
                        <h4 id="reader-project-name" class="text-sm font-bold text-slate-900 truncate">Projekt Name</h4>
                    </div>

                    <div id="section-project-pages">
                        <p
                            class="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] mb-4 flex items-center gap-2">
                            <span class="material-symbols-outlined text-sm">article</span> Projekt Seiten
                        </p>
                        <div id="reader-content-list" class="space-y-1"></div>
                    </div>
                </div>
                <div class="p-6 border-t border-slate-200/50 bg-white/30 backdrop-blur-md">
                    <button onclick="switchTab('notes')"
                        class="w-full py-4 bg-slate-900 text-white rounded-2xl text-xs font-black shadow-xl hover:scale-[1.02] active:scale-95 transition-all flex items-center justify-center gap-2">
                        <span class="material-symbols-outlined text-lg">edit_note</span>
                        NOTIZEN ÖFFNEN
                    </button>
                </div>
            </aside>
            <main class="flex-1 bg-white relative overflow-hidden">
                <iframe id="reader-iframe" src="" class="w-full h-full border-none"></iframe>
                <div id="reader-text-view" class="hidden absolute inset-0 overflow-y-auto bg-white">
                    <div class="max-w-3xl mx-auto px-8 py-16 reader-content-text">
                        <h1 id="reader-mock-title">Titel der Quelle</h1>
                        <p id="reader-mock-body">Inhalt des Reader-Modus...</p>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- MODALS -->
    <!-- Mindmap Node Detail Modal -->
    <!-- Mindmap Node Detail Modal -->
    <div id="modal-node-detail"
        class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-[150] hidden items-center justify-center p-4">
        <div class="glass-panel w-full max-w-2xl rounded-[2.5rem] shadow-2xl animate-in zoom-in-95 duration-200">
            <header class="p-8 border-b border-slate-200/50 flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <div class="w-1.5 h-8 bg-emerald-500 rounded-full"></div>
                    <h2 class="text-xl font-bold text-slate-900">Planungspunkt Details</h2>
                </div>
                <button onclick="closeNodeDetail()" class="p-2 hover:bg-slate-100 rounded-2xl text-slate-400"><span
                        class="material-symbols-outlined text-2xl">close</span></button>
            </header>
            <div class="p-8 space-y-6 max-h-[70vh] overflow-y-auto">
                <div class="space-y-2">
                    <label class="text-[11px] font-black text-slate-400 uppercase tracking-widest ml-1">Titel</label>
                    <input id="node-detail-title" type="text"
                        class="glass-input w-full rounded-2xl px-5 py-4 font-bold text-lg text-slate-800" />
                </div>
                <div class="space-y-2">
                    <label class="text-[11px] font-black text-slate-400 uppercase tracking-widest ml-1">Notizen</label>
                    <textarea id="node-detail-notes"
                        class="glass-input w-full rounded-2xl px-5 py-4 min-h-[120px] text-sm text-slate-600 font-medium"
                        placeholder="Ergänzende Gedanken..."></textarea>
                </div>

                <!-- Linked Resources -->
                <div class="space-y-4">
                    <label class="text-[11px] font-black text-slate-400 uppercase tracking-widest ml-1">Verknüpfte
                        Ressourcen</label>
                    <div id="node-linked-resources" class="grid grid-cols-1 gap-2">
                        <!-- Injected -->
                    </div>
                </div>

                <!-- Picker -->
                <div class="space-y-4 pt-4 border-t border-slate-100">
                    <label class="text-[11px] font-black text-slate-400 uppercase tracking-widest ml-1">Ressourcen
                        verknüpfen</label>
                    <div id="available-resources-picker"
                        class="grid grid-cols-1 gap-2 max-h-[250px] overflow-y-auto pr-2">
                        <!-- Injected -->
                    </div>
                </div>
            </div>
            <footer class="p-8 bg-slate-50/50 flex justify-end gap-4 border-t border-slate-200/50 rounded-b-[2.5rem]">
                <button onclick="closeNodeDetail()"
                    class="px-6 py-3 font-bold text-sm text-slate-500 hover:text-slate-900 transition-colors">Abbrechen</button>
                <button onclick="saveNodeDetails()"
                    class="bg-emerald-600 text-white px-10 py-3 rounded-2xl font-bold text-sm shadow-xl hover:bg-emerald-700 transition-all">Speichern</button>
            </footer>
        </div>
    </div>

    <!-- 5. NOTE EDITOR VIEW -->
    <div id="view-note-editor" class="view fixed inset-0 bg-white z-[125] hidden flex-col">
        <header class="h-20 glass-panel border-b border-white/40 px-10 flex items-center justify-between shrink-0 z-50">
            <div class="flex items-center gap-6">
                <button onclick="closeNoteEditor()"
                    class="p-3 hover:bg-slate-900/5 text-blue-600 rounded-2xl transition-all flex items-center gap-2 font-bold text-sm">
                    <span class="material-symbols-outlined">arrow_back</span>
                    Zurück
                </button>
                <div class="h-8 w-px bg-slate-200"></div>
                <div class="flex flex-col">
                    <h2 class="font-bold text-slate-900 text-lg">Notiz bearbeiten</h2>
                    <p id="editor-meta-date"
                        class="text-[10px] text-slate-400 font-bold uppercase tracking-widest mt-0.5">Januar 31,
                        2026</p>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <button onclick="saveNoteInEditor()"
                    class="flex items-center gap-2 px-8 py-3 bg-blue-600 text-white rounded-2xl text-sm font-bold shadow-xl shadow-blue-500/20 hover:bg-blue-700 transition-all hover:scale-105 active:scale-95">
                    <span class="material-symbols-outlined text-xl">save</span>
                    Speichern
                </button>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto bg-slate-50/30 p-10">
            <div class="max-w-4xl mx-auto space-y-8">
                <!-- Source Info Card -->
                <div class="glass-panel rounded-[2.5rem] p-8 flex items-center justify-between">
                    <div class="flex items-center gap-6">
                        <div
                            class="w-14 h-14 rounded-2xl bg-indigo-50 flex items-center justify-center text-indigo-500">
                            <span class="material-symbols-outlined text-3xl">article</span>
                        </div>
                        <div>
                            <p id="editor-source-title" class="font-bold text-slate-900 line-clamp-1">
                                Quellen-Titel</p>
                            <p id="editor-source-url" class="text-xs text-slate-400 truncate max-w-md">
                                https://beispiel.de/artikel</p>
                        </div>
                    </div>
                    <button onclick="openSourceInEditor()"
                        class="p-4 bg-slate-100/50 hover:bg-slate-200/50 rounded-2xl transition-all group">
                        <span
                            class="material-symbols-outlined text-slate-400 group-hover:text-slate-900">open_in_new</span>
                    </button>
                </div>

                <!-- Editor Section -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-2 space-y-6">
                        <div class="glass-panel rounded-[2.5rem] p-10 space-y-6">
                            <label class="text-[11px] font-black text-slate-400 uppercase tracking-[0.2em] ml-1">Inhalt
                                der Notiz</label>
                            <textarea id="editor-textarea"
                                class="w-full min-h-[400px] bg-transparent border-none focus:ring-0 p-0 text-xl leading-relaxed text-slate-800 placeholder-slate-300 resize-none font-medium italic"
                                placeholder="Schreibe etwas..."></textarea>
                        </div>
                    </div>

                    <div class="space-y-6">
                        <div class="glass-panel rounded-[2.5rem] p-8 space-y-6">
                            <div class="space-y-4">
                                <label
                                    class="text-[11px] font-black text-slate-400 uppercase tracking-[0.2em] ml-1">Kategorie</label>
                                <input id="editor-category" type="text"
                                    class="glass-input w-full rounded-2xl px-6 py-4 text-sm font-bold text-blue-600 uppercase tracking-wider"
                                    placeholder="Z.B. RECHERCHE">
                            </div>

                            <div class="space-y-4">
                                <label
                                    class="text-[11px] font-black text-slate-400 uppercase tracking-[0.2em] ml-1">Tags
                                    (Komma-getrennt)</label>
                                <input id="editor-tags" type="text"
                                    class="glass-input w-full rounded-2xl px-6 py-4 text-sm font-medium text-slate-600"
                                    placeholder="z.B. wichtig, idee, quelle">
                            </div>

                            <div class="pt-4 border-t border-slate-100 flex flex-col gap-3">
                                <label
                                    class="text-[11px] font-black text-slate-400 uppercase tracking-[0.2em] ml-1">Schnellwahl</label>
                                <div class="flex flex-wrap gap-2">
                                    <button onclick="setEditorCat('RECHERCHE')"
                                        class="px-3 py-1.5 bg-slate-100 hover:bg-slate-200 rounded-lg text-[10px] font-bold text-slate-500 transition-all">RECHERCHE</button>
                                    <button onclick="setEditorCat('ZITAT')"
                                        class="px-3 py-1.5 bg-slate-100 hover:bg-slate-200 rounded-lg text-[10px] font-bold text-slate-500 transition-all">ZITAT</button>
                                    <button onclick="setEditorCat('WICHTIG')"
                                        class="px-3 py-1.5 bg-slate-100 hover:bg-slate-200 rounded-lg text-[10px] font-bold text-slate-500 transition-all">WICHTIG</button>
                                </div>
                            </div>
                        </div>

                        <div class="glass-panel rounded-[2.5rem] p-8 bg-red-50/30 border-red-100">
                            <button onclick="deleteNoteFromEditor()"
                                class="w-full flex items-center justify-center gap-3 py-4 text-red-500 font-bold hover:bg-red-50 rounded-2xl transition-all">
                                <span class="material-symbols-outlined">delete</span>
                                Notiz löschen
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>


    <!-- URL hinzufügen -->
    <div id="modal-add-url"
        class="fixed inset-0 bg-slate-900/20 backdrop-blur-sm z-[120] hidden items-center justify-center p-4">
        <div class="glass-panel w-full max-w-xl rounded-[2.5rem] shadow-2xl animate-in zoom-in-95 duration-200">
            <header class="p-8 border-b border-slate-200/50 flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <div class="w-1.5 h-8 bg-blue-500 rounded-full"></div>
                    <h2 class="text-xl font-bold text-slate-900">Neue Webseite hinzufügen</h2>
                </div>
                <button onclick="closeAddUrlModal()"
                    class="p-2 hover:bg-slate-100 rounded-2xl text-slate-400 flex items-center justify-center">
                    <span class="material-symbols-outlined text-2xl">close</span>
                </button>
            </header>
            <div class="p-8 space-y-6">
                <div class="space-y-4">
                    <label
                        class="text-[11px] font-black text-slate-400 uppercase tracking-widest ml-1">Webseiten-URL</label>
                    <input id="url-input-field" class="glass-input w-full rounded-2xl px-6 py-4 text-sm font-medium"
                        placeholder="https://..." type="text" />
                </div>
                <div class="space-y-4">
                    <label class="text-[11px] font-black text-slate-400 uppercase tracking-widest ml-1">Google
                        Suche</label>
                    <input id="google-search-field" class="glass-input w-full rounded-2xl px-6 py-4 text-sm font-medium"
                        placeholder="Recherche Begriff..." type="text" />
                </div>
            </div>
            <footer class="p-8 bg-slate-50/50 flex justify-end gap-4 border-t border-slate-200/50 rounded-b-[2.5rem]">
                <button onclick="closeAddUrlModal()"
                    class="px-6 py-3 font-bold text-sm text-slate-500 hover:text-slate-900 transition-colors">Abbrechen</button>
                <button onclick="addSourceQuick()"
                    class="bg-slate-900 text-white px-10 py-3 rounded-2xl font-bold text-sm shadow-xl">Hinzufügen</button>
            </footer>
        </div>
    </div>

    <!-- Scripting -->
    <script>
        // --- Persistence Variables ---
        let currentProjectName = "";
        let mindmapData = [];
        let activeNodeId = null;

        // --- LIFE CYCLE ---
        window.addEventListener('DOMContentLoaded', () => {
            refreshProjectList().then(() => {
                // Initialize View from URL
                const path = window.location.pathname;
                const search = new URLSearchParams(window.location.search);

                if (path === '/reader' && search.has('url')) {
                    openReader(search.get('url'), search.get('title') || 'Reader', false);
                } else if (path.startsWith('/notes/')) {
                    const id = path.split('/')[2];
                    openNoteEditor(id, false);
                } else if (path !== '/') {
                    const tabId = path.substring(1);
                    const validTabs = ['dashboard', 'library', 'notes', 'mindmap'];
                    if (validTabs.includes(tabId)) {
                        switchTab(tabId, false);
                    }
                }
            });
        });

        window.addEventListener('popstate', (event) => {
            if (event.state) {
                if (event.state.type === 'reader') {
                    openReader(event.state.url, event.state.title, false);
                } else if (event.state.type === 'note') {
                    openNoteEditor(event.state.id, false);
                } else if (event.state.tabId) {
                    switchTab(event.state.tabId, false);
                }
            } else {
                switchTab('dashboard', false);
            }
        });

        // --- UI CORE ---
        function switchTab(tabId, pushState = true) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.getElementById('view-' + tabId).classList.add('active');
            const tabBtn = document.getElementById('tab-' + tabId);
            if (tabBtn) tabBtn.classList.add('active');

            // Hide reader if switched to a tab
            document.getElementById('view-reader').classList.replace('flex', 'hidden');

            if (tabId === 'mindmap') renderMindmap();
            window.scrollTo({ top: 0, behavior: 'smooth' });

            if (pushState) {
                const url = tabId === 'dashboard' ? '/' : `/${tabId}`;
                history.pushState({ tabId }, '', url);
            }
        }

        function toggleProjectDropdown() {
            document.getElementById('project-dropdown-menu').classList.toggle('show');
        }

        // --- BACKEND CONNECTIVITY ---

        async function refreshProjectList() {
            const res = await fetch('/projects');
            const projects = await res.json();
            const items = document.getElementById('project-dropdown-items');
            const savedProject = localStorage.getItem('l8te_last_project');

            items.innerHTML = "";
            Object.keys(projects).forEach(name => {
                const btn = document.createElement('button');
                btn.className = "w-full text-left px-4 py-2 text-sm font-medium hover:bg-blue-600/5 rounded-xl transition-all flex items-center justify-between";
                btn.onclick = () => selectProject(name);
                btn.innerHTML = `${name} <span class="material-symbols-outlined text-blue-600 text-lg opacity-0 check-mark">check</span>`;
                items.appendChild(btn);
            });

            if (savedProject && projects[savedProject]) {
                selectProject(savedProject);
            }
        }

        async function selectProject(name) {
            currentProjectName = name;
            localStorage.setItem('l8te_last_project', name);
            document.getElementById('selected-project-name').innerText = name;
            document.getElementById('project-dropdown-menu').classList.remove('show');
            document.getElementById('no-project-msg').style.display = 'none';
            document.getElementById('main-app').style.display = 'block';

            loadSelectedProject();
        }

        async function loadSelectedProject() {
            const res = await fetch('/projects');
            const projects = await res.json();
            const data = projects[currentProjectName];
            if (!data) return;

            // Load Mindmap Data if exists, else default
            mindmapData = data.mindmap || [
                { id: 1, title: 'Hauptthema', notes: '', urls: [], children: [] }
            ];

            renderDashboard(data);
            renderLibrary(data);
            renderNotes(data);
            if (document.getElementById('view-mindmap').classList.contains('active')) renderMindmap();
        }

        async function createNewProject() {
            const name = prompt("Neuer Projektname:");
            if (name) {
                await fetch('/projects', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: name, urls: [], keywords: '' })
                });
                refreshProjectList();
            }
        }

        async function deleteCurrentProject() {
            if (currentProjectName && confirm(`Projekt "${currentProjectName}" löschen?`)) {
                await fetch(`/projects/${currentProjectName}`, { method: 'DELETE' });
                currentProjectName = "";
                refreshProjectList();
                document.getElementById('main-app').style.display = 'none';
                document.getElementById('no-project-msg').style.display = 'block';
            }
        }

        // --- RENDERERS ---

        function renderDashboard(data) {
            const grid = document.getElementById('recent-grid');
            const recentSources = (data.urls || []).slice(-6).reverse();

            grid.innerHTML = recentSources.map(url => {
                if (url.includes('google.com/search')) return '';
                try {
                    const domain = new URL(url).hostname.replace('www.', '');
                    const favicon = `https://www.google.com/s2/favicons?domain=${domain}&sz=128`;
                    return `
                    <div onclick="openReader('${url}', '${domain}')" class="group relative flex flex-col gap-3 glass-item p-3 rounded-[1.75rem] hover:scale-[1.02] hover:bg-white/50 cursor-pointer">
                        <div class="relative aspect-[4/3] rounded-2xl overflow-hidden shadow-inner bg-slate-50 flex items-center justify-center">
                            <img alt="${domain}" class="w-16 h-16 object-contain" src="${favicon}" onerror="this.src='https://placehold.co/100x100?text=WEB'"/>
                            <div class="absolute inset-0 bg-white/20 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center backdrop-blur-sm">
                                <span class="material-symbols-outlined bg-white/80 p-2 rounded-full shadow-lg">open_in_new</span>
                            </div>
                        </div>
                        <div class="px-1 pb-1">
                            <p class="text-xs font-bold text-slate-800 truncate">${domain}</p>
                            <p class="text-[9px] text-slate-400 truncate uppercase font-bold tracking-tighter">${url.substring(0, 25)}</p>
                        </div>
                    </div>`;
                } catch (e) { return ''; }
            }).join('');

            const noteList = document.getElementById('recent-notes');
            const recentNotes = (data.notes || []).slice(-3).reverse();
            noteList.innerHTML = recentNotes.map(n => `
                <div class="glass-item p-6 rounded-[2rem] hover:bg-white/40 group cursor-pointer" onclick="openNoteEditor('${n.id}')">
                    <div class="flex items-center gap-2 mb-3">
                        <span class="text-[9px] font-black text-blue-500 uppercase tracking-widest">${n.category || 'Allgemein'}</span>
                        <span class="text-[9px] font-bold text-slate-300">• ${n.date}</span>
                    </div>
                    <p class="text-xs leading-relaxed text-slate-600 line-clamp-3 font-medium">${n.text}</p>
                </div>
            `).join('');
        }

        function renderLibrary(data) {
            const grid = document.getElementById('full-library-grid');
            grid.innerHTML = (data.urls || []).map(url => {
                try {
                    const isSearch = url.includes('google.com/search');
                    const domain = isSearch ? 'Google Suche' : new URL(url).hostname.replace('www.', '');
                    const favicon = isSearch ? '' : `https://www.google.com/s2/favicons?domain=${domain}&sz=128`;

                    let display = domain;
                    if (isSearch) {
                        const qMatch = url.match(/q=([^&]+)/);
                        if (qMatch) display = decodeURIComponent(qMatch[1]).replace(/\+/g, ' ');
                    }

                    return `
                        <div onclick="openReader('${url}', '${isSearch ? 'Suche: ' + display : domain}')" class="group relative flex flex-col gap-3 glass-item p-3 rounded-[1.75rem] hover:scale-[1.02] hover:bg-white/50 cursor-pointer">
                            <div class="relative aspect-[4/3] rounded-2xl overflow-hidden bg-slate-50 flex items-center justify-center">
                                ${isSearch ? `<span class="material-symbols-outlined text-slate-300 text-4xl">manage_search</span>` : `<img alt="${domain}" class="w-12 h-12 object-contain" src="${favicon}"/>`}
                            </div>
                            <div class="px-1 pb-1">
                                <p class="text-xs font-bold text-slate-800 truncate">${display}</p>
                                <p class="text-[9px] text-slate-400 uppercase font-black tracking-tight">${isSearch ? 'Google Search' : domain.split('.')[0]}</p>
                            </div>
                        </div>`;
                } catch (e) { return ''; }
            }).join('');
        }

        function renderNotes(data) {
            const list = document.getElementById('notes-list');
            const notes = data.notes || [];
            const groups = {};
            notes.forEach(n => {
                const cat = n.category || 'Allgemein';
                if (!groups[cat]) groups[cat] = [];
                groups[cat].push(n);
            });

            list.innerHTML = Object.keys(groups).sort().map(cat => `
                <div class="space-y-4">
                    <h3 class="flex items-center gap-2 px-1 text-[10px] uppercase tracking-[0.2em] font-bold text-slate-400"><span class="w-1.5 h-1.5 rounded-full bg-blue-500"></span>${cat}</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        ${groups[cat].map(n => {
                let visual = n.type === 'image' ? `<img src="${n.url}" class="rounded-xl mt-4 max-h-32 object-cover border border-slate-100">` : '';
                let tags = (n.tags || []).map(t => `<span class="px-1.5 py-0.5 bg-indigo-50 text-indigo-500 rounded text-[9px] font-bold mr-1">#${t}</span>`).join('');
                return `
                                <div class="glass-item p-8 rounded-[2.5rem] hover:bg-white/40 group cursor-pointer relative" onclick="openNoteEditor('${n.id}')">
                                    <div class="mb-5 flex justify-between items-start">
                                        <div>${tags}</div>
                                        <div class="px-2 py-1 bg-blue-50 text-blue-600 rounded-lg text-[8px] font-black uppercase tracking-widest">${cat}</div>
                                    </div>
                                    <p class="text-sm leading-relaxed text-slate-600 font-medium line-clamp-4 italic">"${n.text}"</p>
                                    ${visual}
                                    <div class="mt-6 pt-6 border-t border-slate-100 flex items-center justify-between">
                                        <span class="text-[9px] font-bold text-slate-300 uppercase tracking-wider">${n.date}</span>
                                        <span class="material-symbols-outlined text-sm text-slate-300 group-hover:text-blue-500 transition-colors">edit</span>
                                    </div>
                                </div>`;
            }).join('')}
                    </div>
                </div>
            `).join('');
        }

        // --- MINDMAP (NETWORK) ---
        let network = null;
        function renderMindmap() {
            const container = document.getElementById('mynetwork');

            // Convert tree structure to flat nodes/edges
            const nodes = [];
            const edges = [];

            const flatten = (items, parentId = null) => {
                items.forEach(item => {
                    nodes.push({
                        id: item.id,
                        label: item.title,
                        group: parentId ? 'child' : 'root',
                        shape: parentId ? 'dot' : 'ellipse'
                    });
                    if (parentId) edges.push({ from: parentId, to: item.id, length: 150 });
                    if (item.children) flatten(item.children, item.id);
                });
            };
            flatten(mindmapData);

            const data = { nodes: new vis.DataSet(nodes), edges: new vis.DataSet(edges) };
            const options = {
                nodes: {
                    font: { face: 'Inter', size: 14, color: '#0f172a' },
                    borderWidth: 2,
                    shadow: true
                },
                groups: {
                    root: {
                        color: { background: '#3b82f6', border: '#2563eb' },
                        font: { color: '#ffffff', bold: true, size: 16 }
                    },
                    child: {
                        color: { background: '#e0f2fe', border: '#bae6fd' },
                        font: { color: '#0369a1', weight: '600' }
                    }
                },
                physics: {
                    stabilization: true,
                    barnesHut: { gravitationalConstant: -2000, centralGravity: 0.3, springLength: 95 }
                }
            };
            network = new vis.Network(container, data, options);
            network.on("click", (params) => {
                if (params.nodes.length > 0) openNodeDetail(params.nodes[0]);
            });
        }

        // Note: In a real app we'd need a backend route to save the Mindmap.
        // For demonstration, let's assume we can save the whole project.
        async function saveMindmapToBackend() {
            await fetch('/projects', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name: currentProjectName,
                    mindmap: mindmapData
                })
            });
        }

        function findNodeInTree(nodes, id) {
            for (let n of nodes) {
                if (n.id == id) return n;
                if (n.children) {
                    let child = findNodeInTree(n.children, id);
                    if (child) return child;
                }
            }
            return null;
        }

        async function openNodeDetail(id) {
            activeNodeId = id;
            const res = await fetch('/projects');
            const projects = await res.json();
            const project = projects[currentProjectName];
            const node = findNodeInTree(mindmapData, id);

            if (!node) return;

            // Basic Info
            document.getElementById('node-detail-title').value = node.title || '';
            document.getElementById('node-detail-notes').value = node.notes || '';

            // Render Linked Resources
            const linkedContainer = document.getElementById('node-linked-resources');
            const linkedIds = node.resources || [];
            linkedContainer.innerHTML = "";

            // Render Picker (Available Resources)
            const picker = document.getElementById('available-resources-picker');
            picker.innerHTML = "";

            // 1. Process Notes
            (project.notes || []).forEach(note => {
                const isLinked = linkedIds.includes(String(note.id));
                const itemHtml = `
                    <div class="flex items-center justify-between p-3 rounded-xl border ${isLinked ? 'bg-indigo-50 border-indigo-200' : 'bg-white border-slate-100 hover:bg-slate-50'} transition-all">
                        <div class="flex items-center gap-3 overflow-hidden">
                            <span class="material-symbols-outlined text-slate-400 text-sm">${note.type === 'image' ? 'image' : 'description'}</span>
                            <p class="text-[11px] font-bold text-slate-700 truncate">${note.text.substring(0, 40)}...</p>
                        </div>
                        <button onclick="toggleResourceLink('${note.id}')" class="p-1 px-3 rounded-lg text-[10px] font-black uppercase tracking-wider ${isLinked ? 'bg-red-50 text-red-500' : 'bg-indigo-600 text-white'}">
                            ${isLinked ? 'Entfernen' : 'Linken'}
                        </button>
                    </div>
                `;
                if (isLinked) linkedContainer.innerHTML += itemHtml;
                else picker.innerHTML += itemHtml;
            });

            // 2. Process URLs
            (project.urls || []).forEach((url, idx) => {
                const urlId = `url-${idx}`;
                const isLinked = linkedIds.includes(urlId);
                const domain = url.includes('google.com') ? 'Suche' : url.split('/')[2];
                const itemHtml = `
                    <div class="flex items-center justify-between p-3 rounded-xl border ${isLinked ? 'bg-blue-50 border-blue-200' : 'bg-white border-slate-100 hover:bg-slate-50'} transition-all">
                        <div class="flex items-center gap-3 overflow-hidden">
                            <span class="material-symbols-outlined text-slate-400 text-sm">link</span>
                            <p class="text-[11px] font-bold text-slate-700 truncate">${domain} (${url.substring(0, 20)}...)</p>
                        </div>
                        <button onclick="toggleResourceLink('${urlId}')" class="p-1 px-3 rounded-lg text-[10px] font-black uppercase tracking-wider ${isLinked ? 'bg-red-50 text-red-500' : 'bg-blue-600 text-white'}">
                            ${isLinked ? 'Entfernen' : 'Linken'}
                        </button>
                    </div>
                `;
                if (isLinked) linkedContainer.innerHTML += itemHtml;
                else picker.innerHTML += itemHtml;
            });

            if (!linkedContainer.innerHTML) linkedContainer.innerHTML = `<p class="text-[10px] text-slate-400 italic p-4 text-center border-2 border-dashed border-slate-100 rounded-2xl">Keine Ressourcen verlinkt</p>`;

            document.getElementById('modal-node-detail').classList.replace('hidden', 'flex');
        }

        async function toggleResourceLink(resId) {
            const node = findNodeInTree(mindmapData, activeNodeId);
            if (!node.resources) node.resources = [];

            const idx = node.resources.indexOf(String(resId));
            if (idx > -1) node.resources.splice(idx, 1);
            else node.resources.push(String(resId));

            await saveMindmapToBackend();
            openNodeDetail(activeNodeId); // Refresh UI
        }

        function closeNodeDetail() { document.getElementById('modal-node-detail').classList.replace('flex', 'hidden'); }

        async function saveNodeDetails() {
            const node = findNodeInTree(mindmapData, activeNodeId);
            node.title = document.getElementById('node-detail-title').value;
            node.notes = document.getElementById('node-detail-notes').value;
            await saveMindmapToBackend();
            closeNodeDetail();
            renderMindmap();
        }

        function addMindmapNode(parentId) {
            const newNode = { id: Date.now(), title: 'Neuer Punkt', notes: '', resources: [], children: [] };
            if (parentId === null) {
                mindmapData.push(newNode);
            } else {
                const parent = findNodeInTree(mindmapData, parentId);
                if (parent) {
                    if (!parent.children) parent.children = [];
                    parent.children.push(newNode);
                }
            }
            saveMindmapToBackend().then(() => {
                renderMindmap();
                if (parentId !== null) openNodeDetail(newNode.id);
            });
        }

        // --- ACTIONS ---

        async function addSourceQuick() {
            const urlVal = document.getElementById('url-input-field').value;
            const searchVal = document.getElementById('google-search-field').value;

            if (urlVal) {
                await fetch('/add_url', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ project: currentProjectName, url: urlVal })
                });
                openReader(urlVal, urlVal.split('/')[2]);
            } else if (searchVal) {
                const url = "https://www.google.com/search?q=" + encodeURIComponent(searchVal);
                openReader(url, "Suche: " + searchVal);
            }

            closeAddUrlModal();
            loadSelectedProject();
        }

        function openReader(url, title, pushState = true) {
            const rView = document.getElementById('view-reader');
            document.getElementById('reader-title').innerText = title;
            document.getElementById('reader-project-name').innerText = currentProjectName;
            document.getElementById('reader-iframe').src = `/proxy?url=${encodeURIComponent(url)}&project=${encodeURIComponent(currentProjectName)}`;

            fetch('/projects').then(r => r.json()).then(projects => {
                const data = projects[currentProjectName];
                const contentList = document.getElementById('reader-content-list');

                if (!contentList) return;

                const urls = data.urls || [];
                const content = urls.filter(u => !u.includes('google.com/search'));

                contentList.innerHTML = content.map(u => {
                    const domain = u.split('/')[2];
                    const active = u === url ? 'bg-blue-600/10 text-blue-600 font-bold border border-blue-200' : 'text-slate-500 hover:text-slate-900 hover:bg-slate-100';
                    return `<button onclick="openReader('${u}', '${domain}')" class="w-full text-left px-3 py-2 text-[10px] rounded-xl flex items-center gap-2 transition-all ${active}">
                                <span class="material-symbols-outlined text-sm">public</span> <span class="truncate">${domain}</span>
                            </button>`;
                }).join('') || '<p class="text-[9px] text-slate-300 italic px-4 py-2">Keine Seiten gespeichert</p>';
            });

            rView.classList.replace('hidden', 'flex');

            if (pushState) {
                const readerUrl = `/reader?url=${encodeURIComponent(url)}&title=${encodeURIComponent(title)}`;
                history.pushState({ type: 'reader', url, title }, '', readerUrl);
            }
        }

        function toggleReaderModeInline() {
            const iframe = document.getElementById('reader-iframe');
            const url = new URL(iframe.src, window.location.origin);
            const isReader = url.searchParams.get('reader') === 'true';

            if (isReader) {
                url.searchParams.delete('reader');
                document.getElementById('reader-status-label').innerText = 'AUS';
            } else {
                url.searchParams.set('reader', 'true');
                document.getElementById('reader-status-label').innerText = 'EIN';
            }
            iframe.src = url.toString();
        }

        function startSidebarSearchInline() {
            const query = document.getElementById('reader-inline-search').value;
            if (!query) return;
            const googleUrl = "https://www.google.com/search?q=" + encodeURIComponent(query);
            openReader(googleUrl, "Suche: " + query);
        }

        function closeReader() {
            document.getElementById('view-reader').classList.replace('flex', 'hidden');
            loadSelectedProject();

            // Go back to last tab
            const activeTab = document.querySelector('.nav-tab.active')?.id.replace('tab-', '') || 'dashboard';
            switchTab(activeTab);
        }

        function setReaderMode(mode) {
            const iframe = document.getElementById('reader-iframe');
            const url = new URL(iframe.src);
            if (mode === 'reader') {
                url.searchParams.set('reader', 'true');
                document.getElementById('btn-reader').className = "px-5 py-1.5 text-xs font-bold rounded-xl transition-all bg-white shadow-sm text-blue-600";
                document.getElementById('btn-orig').className = "px-5 py-1.5 text-xs font-bold rounded-xl transition-all text-slate-400";
            } else {
                url.searchParams.delete('reader');
                document.getElementById('btn-orig').className = "px-5 py-1.5 text-xs font-bold rounded-xl transition-all bg-white shadow-sm text-blue-600";
                document.getElementById('btn-reader').className = "px-5 py-1.5 text-xs font-bold rounded-xl transition-all text-slate-400";
            }
            iframe.src = url.toString();
        }

        async function autoGroupNotes() {
            await fetch('/auto_group', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ project: currentProjectName })
            });
            loadSelectedProject();
        }

        async function deleteNote(id) {
            if (confirm("Löschen?")) {
                await fetch('/delete_note', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ project: currentProjectName, id: id })
                });
                loadSelectedProject();
            }
        }

        // --- NOTE EDITOR ---
        let activeNoteId = null;

        function openNoteEditor(id, pushState = true) {
            activeNoteId = id;
            fetch('/projects').then(r => r.json()).then(projects => {
                let targetProject = currentProjectName;
                let note = null;

                // Robustness: If current project doesn't have it, search all
                if (targetProject && projects[targetProject]) {
                    note = projects[targetProject].notes.find(n => n.id === id);
                }

                if (!note) {
                    for (let pName in projects) {
                        let found = projects[pName].notes.find(n => n.id === id);
                        if (found) {
                            note = found;
                            targetProject = pName;
                            currentProjectName = pName;
                            document.getElementById('selected-project-name').innerText = pName;
                            break;
                        }
                    }
                }

                if (!note) {
                    alert("Notiz nicht gefunden.");
                    return;
                }

                document.getElementById('editor-textarea').value = note.text;
                document.getElementById('editor-category').value = note.category || "UNSORTIERT";
                document.getElementById('editor-source-title').innerText = note.title || "Ohne Titel";
                document.getElementById('editor-source-url').innerText = note.url || "";
                document.getElementById('editor-meta-date').innerText = note.date;

                // Tags handling
                const tagInput = document.getElementById('editor-tags');
                if (tagInput) tagInput.value = (note.tags || []).join(', ');

                // Set metadata for source link
                document.getElementById('editor-source-url').onclick = () => window.open(note.url, '_blank');

                const editorView = document.getElementById('view-note-editor');
                editorView.classList.remove('hidden');
                editorView.classList.add('active', 'flex', 'view-animate-in');

                // Remove animation class after it plays to allow re-triggering? 
                // Actually better to keep it or remove it on close.

                if (pushState) {
                    history.pushState({ type: 'note', id }, '', `/notes/${id}`);
                }
            });
        }

        function closeNoteEditor() {
            const editorView = document.getElementById('view-note-editor');
            editorView.classList.add('hidden');
            editorView.classList.remove('active', 'flex', 'view-animate-in');

            const activeTab = document.querySelector('.nav-tab.active')?.id.replace('tab-', '') || 'notes';
            switchTab(activeTab);
        }

        function setEditorCat(cat) {
            document.getElementById('editor-category').value = cat;
        }

        async function saveNoteInEditor() {
            const btn = document.querySelector('[onclick="saveNoteInEditor()"]');
            const originalHtml = btn.innerHTML;
            btn.innerHTML = '<span class="material-symbols-outlined animate-spin">sync</span> SPEICHERT...';
            btn.disabled = true;

            const newText = document.getElementById('editor-textarea').value;
            const newCat = document.getElementById('editor-category').value;
            const tagInput = document.getElementById('editor-tags');
            const newTags = tagInput ? tagInput.value.split(',').map(t => t.trim()).filter(t => t) : [];

            await fetch('/edit_note', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    project: currentProjectName,
                    id: activeNoteId,
                    text: newText,
                    category: newCat,
                    tags: newTags
                })
            });

            setTimeout(() => {
                btn.innerHTML = '<span class="material-symbols-outlined">check</span> GESPEICHERT';
                btn.classList.replace('bg-blue-600', 'bg-green-600');
                loadSelectedProject();
                setTimeout(() => {
                    btn.innerHTML = originalHtml;
                    btn.classList.replace('bg-green-600', 'bg-blue-600');
                    btn.disabled = false;
                }, 2000);
            }, 500);
        }

        function deleteNoteFromEditor() {
            if (confirm("Notiz wirklich löschen?")) {
                deleteNote(activeNoteId);
                closeNoteEditor();
            }
        }

        function openSourceInEditor() {
            const url = document.getElementById('editor-source-url').innerText;
            const title = document.getElementById('editor-source-title').innerText;
            if (url) openReader(url, title);
        }

        function openAddUrlModal() { document.getElementById('modal-add-url').classList.replace('hidden', 'flex'); }
        function closeAddUrlModal() { document.getElementById('modal-add-url').classList.replace('flex', 'hidden'); }

        function exportProject() { window.location.href = `/export/${currentProjectName}`; }

        function toggleSidebar() { document.getElementById('reader-sidebar').classList.toggle('collapsed'); }

        function filterNotes() {
            const query = document.getElementById('note-search-input').value.toLowerCase();
            document.querySelectorAll('.note-card').forEach(card => {
                // Not using note-card class in the new render yet, let's fix that
            });
            // Re-render notes is safer for now if we filter in memory
        }

        function startSidebarSearch() {
            const query = document.getElementById('sidebar-search').value;
            if (!query) return;
            const url = "https://www.google.com/search?q=" + encodeURIComponent(query);
            openReader(url, "Suche");
        }

        // Bridge function for the header save button
        function saveSelectedTextFromHeader() {
            const iframe = document.getElementById('reader-iframe');
            if (iframe && iframe.contentWindow) {
                iframe.contentWindow.postMessage({ action: 'triggerSave' }, '*');
            }
        }

        // Listen for messages from the iframe (e.g. text selected)
        window.addEventListener('message', function (event) {
            if (event.data.action === 'textSelected') {
                const saveBtn = document.getElementById('header-save-btn');
                if (event.data.hasSelection) {
                    saveBtn.classList.replace('hidden', 'flex');
                } else {
                    saveBtn.classList.replace('flex', 'hidden');
                }
            }
            if (event.data.action === 'saveDone') {
                const saveBtn = document.getElementById('header-save-btn');
                saveBtn.innerHTML = '<span class="material-symbols-outlined text-sm">check</span> GESPEICHERT';
                saveBtn.classList.remove('bg-indigo-600');
                saveBtn.classList.add('bg-green-600');
                setTimeout(() => {
                    saveBtn.classList.replace('flex', 'hidden');
                    saveBtn.innerHTML = '<span class="material-symbols-outlined text-sm">edit_note</span> AUSWAHL SPEICHERN';
                    saveBtn.classList.remove('bg-green-600');
                    saveBtn.classList.add('bg-indigo-600');
                }, 2000);
            }
        });

    </script>
</body>

</html>